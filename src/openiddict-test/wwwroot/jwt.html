<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="utf-8" />
</head>
<body>
    <h1>JS-based resource owner sample</h1>
    <div>
        <label>username</label>
        <input id="username" value="bob" />
    </div>
    <div>
        <label>password</label>
        <input id="password" value="bob" />
    </div>
    <div>
        <button id="button">Get Token</button>
    </div>
    <strong id="date"></strong>
    <pre style="max-width:100%;white-space: normal;" id="response"></pre>
    <pre style="max-width:100%;white-space: normal;" id="token"></pre>
    <script>
        var baseUrl = window.location.protocol + "//" + window.location.host + "/connect/authorize/";

        var client_id = "MyWebsite";
        var client_secret = "secret";

        document.getElementById("button").addEventListener("click", getToken, false);

        function decodeToken(token) {
            var parts = token.split('.');

            if (parts.length !== 3) {
                throw new Error('JWT must have 3 parts');
            }

            var decoded = urlBase64Decode(parts[1]);
            if (!decoded) {
                throw new Error('Cannot decode the token');
            }

            return JSON.parse(decoded);
        }

        function urlBase64Decode (str) {
            var output = str.replace('-', '+').replace('_', '/');
            switch (output.length % 4) {
                case 0: { break; }
                case 2: { output += '=='; break; }
                case 3: { output += '='; break; }
                default: {
                    throw 'Illegal base64url string!';
                }
            }
            return window.atob(output); //polifyll https://github.com/davidchambers/Base64.js
        }

        function getToken() {
            var uid = document.getElementById("username").value;
            var pwd = document.getElementById("password").value;

            document.getElementById("date").innerText = "loading...";
            document.getElementById("response").innerText = "loading...";
            document.getElementById("token").innerText = "";

            var xhr = new XMLHttpRequest();
            xhr.onload = function (e) {

                console.log(xhr.status);
                console.log(xhr.response);

                document.getElementById("date").innerText = new Date().toString();
                document.getElementById("response").innerText = xhr.response;
                var decodedToken = decodeToken(JSON.parse(xhr.response).access_token);
                document.getElementById("token").innerText = JSON.stringify(decodedToken);

                var response_data = JSON.parse(xhr.response);
                //if (xhr.status === 200 && response_data.access_token) {
                //    revokeToken(response_data.access_token);
                //}
            }
            xhr.open("POST", baseUrl);
            var data = {
                username: uid,
                password: pwd,
                grant_type: "password",
                scope: "test12",
                client_id: client_id,
                client_secret:client_secret
            };
            var body = "";
            for (var key in data) {
                if (body.length) {
                    body += "&";
                }
                body += key + "=";
                body += encodeURIComponent(data[key]);
            }
            xhr.setRequestHeader("Authorization", "Basic " + btoa(client_id + ":" + client_secret));
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.send(body);
        }

        function revokeToken(token) {
            var xhr = new XMLHttpRequest();
            xhr.onload = function (e) {
                console.log(xhr.status);
                console.log(xhr.response);
            }
            xhr.open("POST", revokeUrl);
            var data = {
                token: token,
                //token_type_hint:"access_token",
                //client_id: client_id,
                //client_secret:client_secret
            };
            var body = "";
            for (var key in data) {
                if (body.length) {
                    body += "&";
                }
                body += key + "=";
                body += encodeURIComponent(data[key]);
            }
            //xhr.setRequestHeader("Authorization", "Basic " + btoa(client_id + ":" + client_secret));
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.send(body);
        }
    </script>
</body>
</html>
